# 8. HTTP 헤더2 - 캐시와 조건부 요청
### 8.1. 캐시 기본 동작
이미지를 요청했을 때 브라우저 캐시에 저장해두면 2번째 호출부터는 네트워크를 탈 필요가 없다.  
캐시 유효 시간이 초과했다면 다시 서버에 요청하고 캐시를 갱신한다.

### 8.2. 검증 헤더와 조건부 요청1
캐시 유효시간이 초과해 서버에 다시요청하면 기존 데이터가 변경 됐을수도, 안됐을수도 있다.  
변경이 안되었다면 굳이 다시 다운로드를 받을 필요는 없다.  
서버의 데이터와 브라우저 캐시의 데이터가 같다는걸 검증하면된다.  
마지막 수정일을 헤더에 추가해서 보내고 서버에서 수정일이 같다면 서버에서 http body 없이 헤더 메타 정보만 보낸다.  
304 Not Modified로 확인할 수 있다.

### 8.3. 검증 헤더와 조건부 요청2
검증 헤더 : 캐시 데이터와 서버 데이터가 같은지 검증하는 데이터
- Last-Modified, ETag

조건부 요청 헤더 : 검증 헤더로 조건에 따른 분기
- If-Modified-Since : Last-Modified 사용
- If-None-Match : ETag 사용
- 조건이 만족하면 200 OK
- 조건이 만족하지 않으면 304 Not Modified

If-Modified-Since : 이후에 데이터가 수정되었으면?
- 데이터 미변경 예시
  - 수정이 안됐음
  - 304 Not Modified, 헤더 데이터만 전송(Body 미포함)
- 데이터 변경 예시
  - 수정이 됐음
  - 200 OK, 모든 데이터 전송(Body 포함)

Last-Modified, If-Modified-Since 단점
- 1초 미만 단위로 캐시 조정이 불가능
- 날짜 기반의 로직 사용 (A에서 B로 바꿨다 다시 A로 바꾸면 원본이랑 같지만 전체 데이터 다운로드함)
- 서버에서 별도의 캐시 로직을 관리하고 싶은 경우

ETag, If-None-Match
- ETag(Entity Tag)
- 캐시용 데이터에 임의의 고유한 버전 이름(해시)을 달아둠
- 데이터가 변경되면 이 이름을 바꾸어서 변경함
- 진짜 단순하게 ETag만 보내서 같으면 유지, 다르면 다시받기!
- 해시값으로 확인하다고 생각하면된다.
- 캐시 서제어 로직을 서버에서 완전히 관리

### 8.4. 캐시와 조건부 요청 헤더
캐시 제어 헤더
- Cache-Control : 캐시 제어, 이걸로 다 할 수 있음.
  - max-age : 캐시 유효 시간, 초 단위
  - no-cache : 데이터는 캐시해도 되지만, 항상 origin 서버에 검증하고 사용
  - no-store : 데이터에 민감한 정보가 있으므로 저장하면 안됨
- Pragma : 캐시 제어(하위 호환)
  - no-cache 처럼 동작함
- Expires : 캐시 유효 기간(하위 호환)
  - 정확한 날짜로 지정할 수 있다.
  - 하지만 초단위로 넣는게 더 유연하다.
  - max-age와 함께 사용되면 무시된다.

### 8.5. 프록시 캐시
CDN으로 보면 된다.(aws는 CloudFront)
- Cache-Control : public
  - 응답이 public 캐시에 저장되어도 됨
- Cache-Control : private
  - 응답이 해당 사용자만을 위한것임, private 캐시에 저장해야함
- Cache-Control : s-maxage
  - 프록시 캐시에만 적용되는 max-age
- Age : 60
  - 오리진 서버에서 응답 후 프록시 캐시 내에 머문 시간(초)

### 8.6. 캐시 무효화
확실한 캐시 무효화를 위해서는 아래를 넣어줘야 한다.
- Cache-Control
  - no-cache : 데이터는 캐시해도 되지만 항상 원 서버에 검증하고 사용, 원 서버에 접근할 수 없는 경우 오류보다는 오래된 데이터라도 보여주는게 must-revalidate와 차이다.
  - no-store : 데이터에 민감한 정보가 있으므로 저장하면 안됨
  - must-revalidate : 캐시 만료 후 최초 조회시 원 서버에 검증해야함, 원 서버 접근 실패시 반드시 오류가 발생해야함(504 Gateway Timeout), 캐시 유효 시간이라면 캐시를 사용함
- Pragma : no-cache
  - HTTP 1.0 하위 호환


